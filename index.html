<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CodeChat — 16-digit code messaging (Demo)</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa6bb;--accent:#3b82f6;--accent-2:#06b6d4}
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;background:linear-gradient(180deg,#071023 0%, #07182b 100%);color:#e6eef8;min-height:100vh;padding:28px}
    .app{max-width:980px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center}
    h1{margin:0;font-size:20px}
    .card{background:rgba(255,255,255,0.03);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .flex{display:flex;gap:12px}
    .col{display:flex;flex-direction:column;gap:8px}
    .muted{color:var(--muted);font-size:13px}
    .code-pill{font-family:monospace;background:linear-gradient(90deg,#05102b,#082036);padding:10px;border-radius:8px;letter-spacing:2px}
    button{background:var(--accent);border:none;padding:8px 10px;border-radius:8px;color:white;cursor:pointer}
    input,textarea,select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .sidebar{width:280px}
    .main{flex:1}
    .friends-list{display:flex;flex-direction:column;gap:8px;max-height:480px;overflow:auto}
    .friend{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center}
    .messages{height:420px;overflow:auto;padding:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:8px}
    .msg{padding:8px;border-radius:8px;max-width:70%;margin-bottom:8px}
    .mine{background:rgba(56,189,248,0.12);align-self:flex-end}
    .theirs{background:rgba(255,255,255,0.03);align-self:flex-start}
    .small{font-size:12px;color:var(--muted)}
    .danger{background:#ef4444}
    .note{font-size:13px;color:var(--muted);margin-top:6px}
    .row{display:flex;gap:8px;align-items:center}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="app">
    <header class="card">
      <div style="flex:1">
        <h1>CodeChat — messaging by 16-digit code</h1>
        <div class="muted">Runs in your browser. Optional: connect Firebase for a real backend (instructions included).</div>
      </div>
      <div class="col" style="align-items:flex-end">
        <div class="muted">Your 16-digit code</div>
        <div class="code-pill" id="myCode">...</div>
      </div>
    </header>

    <div style="height:14px"></div>

    <div class="flex">
      <aside class="sidebar card col">
        <div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <div>
              <div class="muted">Account</div>
              <div id="userId" class="small muted">ID: ...</div>
            </div>
            <div style="text-align:right">
              <button id="changeCodeBtn">Change code</button>
              <div class="note" id="codeCooldownNote"></div>
            </div>
          </div>
        </div>

        <hr style="opacity:0.06;margin:8px 0">

        <div>
          <div class="muted">Add friend by code</div>
          <div class="row"><input id="addCodeInput" placeholder="1234 5678 9012 3456"><button id="addFriendBtn">Add</button></div>
          <div id="addResult" class="small muted"></div>
        </div>

        <div>
          <div style="margin-top:8px" class="muted">Friends</div>
          <div class="friends-list" id="friendsList"></div>
        </div>

        <hr style="opacity:0.06;margin:8px 0">
        <div class="muted">Mode</div>
        <div class="small muted">This app auto-detects if you put Firebase config into the bottom of this file. If not, it runs in Local Demo Mode (messages stored in your browser).</div>

        <div style="margin-top:8px" class="small muted">Local demo limitations: you can only chat with friends whose data is also stored in the same browser (or you import their exported file). To have a real multi-user app, set up Firebase and paste the config below (instructions in footer).
        </div>

        <div style="margin-top:6px" class="row"><button id="exportBtn">Export my account</button><button id="importBtn">Import</button></div>
        <input id="importInput" type="file" accept="application/json" style="display:none">
      </aside>

      <main class="main col card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Chat</div>
            <div id="chatWith" class="muted small">No friend selected</div>
          </div>
          <div>
            <button id="clearBtn" class="danger">Clear local data</button>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="messages col" id="messages"></div>

        <div style="height:8px"></div>
        <div class="row">
          <input id="messageInput" placeholder="Type a message" style="flex:1">
          <button id="sendBtn">Send</button>
        </div>
        <div id="statusNote" class="note"></div>
      </main>
    </div>

    <footer class="card">
      <div class="small muted">Deploy: create a GitHub repo, add this file as <code>index.html</code>, then enable GitHub Pages on the repository (Settings → Pages → choose branch main / root). If you want real multi-user messaging, follow the Firebase instructions in the comments at the bottom of this file and paste your Firebase config into the <code>FIREBASE_CONFIG</code> placeholder in this HTML.</div>
    </footer>
  </div>

  <!-- Firebase SDK is loaded conditionally below in JS if FIREBASE_CONFIG is filled -->

  <script>
  // ------------------- App logic -------------------
  const MS_PER_DAY = 24*60*60*1000;
  const CODE_COOLDOWN_DAYS = 3;

  // LocalStorage keys
  const LS_KEY = 'codechat_account_v1';

  // Replace the object below with your Firebase config (from Firebase console) to enable real backend.
  // Example (DO NOT COMMIT your real keys to a public repo):
  // const FIREBASE_CONFIG = {apiKey: "...", authDomain: "...", databaseURL: "...", projectId: "...", storageBucket: "...", messagingSenderId: "...", appId: "..."};
  const FIREBASE_CONFIG = null; // <-- paste your config object here to enable Firebase mode

  let firebaseEnabled = false;
  let db = null;

  function rnd16Digits(){
    let s='';
    for(let i=0;i<16;i++) s += Math.floor(Math.random()*10);
    return s.match(/\d{4}/g).join(' ');
  }

  function now(){return Date.now();}

  function loadLocalAccount(){
    let raw = localStorage.getItem(LS_KEY);
    if(raw) return JSON.parse(raw);
    const acc = {
      userId: 'u-' + Math.random().toString(36).slice(2,10),
      code: rnd16Digits(),
      codeLastChanged: now(),
      friends: [], // {userId, code, label}
      messages: {} // friendUserId -> [{from:'me'|'them',text,ts}]
    };
    localStorage.setItem(LS_KEY, JSON.stringify(acc));
    return acc;
  }

  function saveLocalAccount(acc){ localStorage.setItem(LS_KEY, JSON.stringify(acc)); }

  let account = loadLocalAccount();
  let currentFriend = null;

  // UI elements
  const myCodeEl = document.getElementById('myCode');
  const userIdEl = document.getElementById('userId');
  const friendsListEl = document.getElementById('friendsList');
  const messagesEl = document.getElementById('messages');
  const chatWithEl = document.getElementById('chatWith');
  const codeCooldownNote = document.getElementById('codeCooldownNote');
  const statusNote = document.getElementById('statusNote');

  function renderAccount(){
    myCodeEl.textContent = account.code;
    userIdEl.textContent = 'ID: ' + account.userId;
    const daysLeft = CODE_COOLDOWN_DAYS - Math.floor((now() - account.codeLastChanged)/MS_PER_DAY);
    if(daysLeft>0){
      codeCooldownNote.textContent = `Can change in ${daysLeft} day(s)`;
      document.getElementById('changeCodeBtn').disabled = true;
    } else {
      codeCooldownNote.textContent = '';
      document.getElementById('changeCodeBtn').disabled = false;
    }

    // friends
    friendsListEl.innerHTML = '';
    account.friends.forEach(f => {
      const el = document.createElement('div'); el.className='friend';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:600">${f.label||f.userId}</div><div class="small muted">${f.code}</div>`;
      const right = document.createElement('div');
      const btn = document.createElement('button'); btn.textContent='Chat'; btn.onclick = ()=>selectFriend(f.userId);
      const rm = document.createElement('button'); rm.textContent='Remove'; rm.style.background='transparent'; rm.style.border='1px solid rgba(255,255,255,0.04)'; rm.style.color='var(--muted)'; rm.onclick=()=>removeFriend(f.userId);
      right.appendChild(btn); right.appendChild(rm);
      el.appendChild(left); el.appendChild(right);
      friendsListEl.appendChild(el);
    });

    renderMessages();
  }

  function selectFriend(id){
    currentFriend = account.friends.find(f=>f.userId===id) || null;
    chatWithEl.textContent = currentFriend ? `Chatting with ${currentFriend.label||currentFriend.userId}` : 'No friend selected';
    renderMessages();
  }

  function renderMessages(){
    messagesEl.innerHTML = '';
    if(!currentFriend){ messagesEl.innerHTML = '<div class="muted">Select a friend to start chatting.</div>'; return; }
    const msgs = account.messages[currentFriend.userId] || [];
    msgs.forEach(m=>{
      const el = document.createElement('div'); el.className='msg ' + (m.from==='me'?'mine':'theirs'); el.textContent = m.text;
      const time = document.createElement('div'); time.className='small'; time.textContent = new Date(m.ts).toLocaleString(); el.appendChild(time);
      messagesEl.appendChild(el);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function removeFriend(id){ account.friends = account.friends.filter(f=>f.userId!==id); delete account.messages[id]; saveLocalAccount(account); renderAccount(); }

  document.getElementById('changeCodeBtn').addEventListener('click', ()=>{
    const confirmed = confirm('Change your 16-digit code? You can only change once every 3 days.');
    if(!confirmed) return;
    account.code = rnd16Digits(); account.codeLastChanged = now(); saveLocalAccount(account);
    if(firebaseEnabled){ // update backend user record
      db.ref('users/'+account.userId).set({code:account.code,codeLastChanged:account.codeLastChanged, userId:account.userId});
    }
    renderAccount();
    alert('Code changed to: ' + account.code);
  });

  document.getElementById('addFriendBtn').addEventListener('click', ()=>{
    const raw = document.getElementById('addCodeInput').value.trim().replace(/\s+/g,' ');
    if(!raw){ document.getElementById('addResult').textContent='Enter a code.'; return; }
    addFriendByCode(raw).then(r=>{ document.getElementById('addResult').textContent = r; renderAccount(); });
  });

  async function addFriendByCode(code){
    if(firebaseEnabled){
      // query users by code
      const snapshot = await db.ref('users').orderByChild('code').equalTo(code).once('value');
      const val = snapshot.val();
      if(!val) return 'No user found with that code.';
      const uid = Object.keys(val)[0];
      if(uid===account.userId) return 'You cannot add yourself.';
      if(account.friends.some(f=>f.userId===uid)) return 'Already friends.';
      const friend = {userId: uid, code: code, label: val[uid].displayName || uid};
      account.friends.push(friend); saveLocalAccount(account);
      return 'Friend added (via Firebase backend).';
    } else {
      // local demo mode: importing another account's exported JSON is necessary
      // attempt to find friend in localStorage (if both users used same browser)
      const all = JSON.parse(localStorage.getItem(LS_KEY+'_registry') || '[]');
      const found = all.find(a=>a.code===code);
      if(found){
        if(found.userId===account.userId) return 'You cannot add yourself.';
        if(account.friends.some(f=>f.userId===found.userId)) return 'Already friends.';
        account.friends.push({userId:found.userId, code:found.code, label:found.userId}); saveLocalAccount(account);
        return 'Friend added (local demo).';
      }
      return 'Local mode: no user with that code found. To add someone, have them export their account and import it into your browser (Export / Import buttons).';
    }
  }

  document.getElementById('exportBtn').addEventListener('click', ()=>{
    const data = JSON.stringify({userId:account.userId, code:account.code, codeLastChanged:account.codeLastChanged},null,2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download = 'codechat_user_'+account.userId+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  document.getElementById('importBtn').addEventListener('click', ()=>{ document.getElementById('importInput').click(); });
  document.getElementById('importInput').addEventListener('change', (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{ const data = JSON.parse(reader.result); // expected {userId,code,...}
        let reg = JSON.parse(localStorage.getItem(LS_KEY+'_registry') || '[]');
        if(!reg.some(x=>x.userId===data.userId)) reg.push({userId:data.userId,code:data.code});
        localStorage.setItem(LS_KEY+'_registry', JSON.stringify(reg));
        alert('Imported account into local registry. Now you can add friend using their code (Local Demo Mode).');
      }catch(err){ alert('Invalid file'); }
    };
    reader.readAsText(file);
  });

  document.getElementById('sendBtn').addEventListener('click', sendMessage);
  document.getElementById('messageInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendMessage(); });

  function sendMessage(){
    const text = document.getElementById('messageInput').value.trim(); if(!text || !currentFriend) return;
    const msg = {from:'me', text, ts: now()};
    account.messages[currentFriend.userId] = account.messages[currentFriend.userId] || [];
    account.messages[currentFriend.userId].push(msg);
    saveLocalAccount(account);

    // push to firebase if enabled
    if(firebaseEnabled){
      const msgRecord = {from:account.userId, text, ts: msg.ts};
      const path = `messages/${[account.userId,currentFriend.userId].sort().join('_')}`; // shared chat path
      db.ref(path).push(msgRecord);
    }

    document.getElementById('messageInput').value=''; renderMessages();
  }

  document.getElementById('clearBtn').addEventListener('click', ()=>{
    if(confirm('Clear ALL local data for this app? This will remove friends, messages, and your account.')){
      localStorage.removeItem(LS_KEY); location.reload();
    }
  });

  function initFirebaseAndStart(config){
    // load firebase scripts dynamically
    const s1 = document.createElement('script'); s1.src='https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';
    const s2 = document.createElement('script'); s2.src='https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js';
    s1.onload = ()=>{ s2.onload = ()=>{
      try{
        firebase.initializeApp(config);
        db = firebase.database(); firebaseEnabled = true;
        // ensure user exists
        db.ref('users/'+account.userId).set({code:account.code,codeLastChanged:account.codeLastChanged, userId:account.userId});

        // listen for new messages on any chat involving me
        const userChatsRef = db.ref('messages');
        userChatsRef.on('value', snapshot=>{
          const all = snapshot.val() || {};
          // iterate all chat rooms and pull messages relevant to my friends
          for(const room in all){
            const parts = room.split('_');
            if(parts.includes(account.userId)){
              const other = parts[0]===account.userId?parts[1]:parts[0];
              const msgs = [];
              for(const k in all[room]) msgs.push(all[room][k]);
              // add to local messages
              account.messages[other] = msgs.map(m=>({from: m.from===account.userId? 'me':'them', text:m.text, ts:m.ts}));
            }
          }
          saveLocalAccount(account);
          renderAccount();
        });

        statusNote.textContent = 'Connected to Firebase backend. Real multi-user chat enabled.';
      }catch(e){ console.error(e); statusNote.textContent = 'Firebase init failed: '+e.message; }
    }; document.head.appendChild(s2); }; document.head.appendChild(s1);
  }

  // Start
  renderAccount();
  if(FIREBASE_CONFIG){
    try{ initFirebaseAndStart(FIREBASE_CONFIG); }
    catch(e){ console.error('firebase init error',e); }
  } else {
    statusNote.textContent = 'Running in Local Demo Mode (no Firebase config provided). To enable real backend, paste your Firebase config into FIREBASE_CONFIG variable in the HTML.';
  }

  // auto-select first friend if exists
  if(account.friends.length) selectFriend(account.friends[0].userId);
  </script>

  <!--
    FIREBASE SETUP INSTRUCTIONS (paste and replace FIREBASE_CONFIG variable above with your config object):

    1) Go to https://console.firebase.google.com and create a new project.
    2) In the project, go to Realtime Database -> Create database -> Start in test mode (for development).
    3) Copy your project's config object from Project settings -> General -> Your apps -> Add web app. It'll look like:
       { apiKey: "...", authDomain: "...", databaseURL: "https://<project>.firebaseio.com", projectId: "...", storageBucket: "...", messagingSenderId: "...", appId: "..." }
    4) Paste that object into FIREBASE_CONFIG in this HTML file (replace the null).
    5) Deploy this index.html to GitHub Pages or host it somewhere. The app will then use Firebase Realtime Database to store user records and messages.

    SECURITY NOTE: Do NOT leave your Firebase Realtime Database in test mode for production. Configure database rules and authentication before releasing publicly.
  -->
</body>
</html>
